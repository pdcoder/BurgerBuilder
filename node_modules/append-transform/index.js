'use strict';
<<<<<<< HEAD
const js = require('default-require-extensions/js');

module.exports = appendTransform;

let count = 0;
=======

var js = require('default-require-extensions/js');

module.exports = appendTransform;

var count = 0;
>>>>>>> 9d495daa1a0bedb7580a62196378715ed1a6d186

function appendTransform(transform, ext, extensions) {
	// Generate a unique key for this transform
	var key = __dirname + count; // eslint-disable-line
	count++;
	ext = ext || '.js';
	extensions = extensions || require.extensions;

<<<<<<< HEAD
	let forwardGet;
	let forwardSet;

	const descriptor = Object.getOwnPropertyDescriptor(extensions, ext) || {value: js, configurable: true};
=======
	var forwardGet;
	var forwardSet;

	var descriptor = Object.getOwnPropertyDescriptor(extensions, ext) || {value: js, configurable: true};
>>>>>>> 9d495daa1a0bedb7580a62196378715ed1a6d186

	if (
		((descriptor.get || descriptor.set) && !(descriptor.get && descriptor.set)) ||
		!descriptor.configurable
	) {
		throw new Error('Somebody did bad things to require.extensions["' + ext + '"]');
	}

	if (descriptor.get) {
<<<<<<< HEAD
		// Wrap a previous append-transform install and pass through to the getter/setter pair it created
=======
		// wrap a previous append-transform install and pass through to the getter/setter pair it created
>>>>>>> 9d495daa1a0bedb7580a62196378715ed1a6d186
		forwardGet = function () {
			return descriptor.get();
		};
		forwardSet = function (val) {
			descriptor.set(val);
			return forwardGet();
		};
	} else {
		forwardGet = function () {
			return descriptor.value;
		};
		forwardSet = function (val) {
			descriptor.value = val;
			return val;
		};
	}

	function wrapCustomHook(hook) {
		return function (module, filename) {
			// We wrap every added extension, but we only apply the transform to the one on top of the stack
			if (!module[key]) {
				module[key] = true;

<<<<<<< HEAD
				const originalCompile = module._compile;

				// eslint-disable-next-line func-name-matching func-names
=======
				var originalCompile = module._compile;

>>>>>>> 9d495daa1a0bedb7580a62196378715ed1a6d186
				module._compile = function replacementCompile(code, filename) {
					module._compile = originalCompile;
					code = transform(code, filename);
					module._compile(code, filename);
				};
			}

			hook(module, filename);
		};
	}

<<<<<<< HEAD
	// Wrap the original
	forwardSet(wrapCustomHook(forwardGet()));

	const hooks = [forwardGet()];

	function setCurrentHook(hook) {
		const restoreIndex = hooks.indexOf(hook);

		if (restoreIndex === -1) {
			hooks.push(forwardSet(wrapCustomHook(hook)));
		} else {
			// We have already scene this hook, and it is being reverted (proxyquire, etc) - don't wrap again.
=======
	// wrap the original
	forwardSet(wrapCustomHook(forwardGet()));

	var hooks = [forwardGet()];

	function setCurrentHook(hook) {
		var restoreIndex = hooks.indexOf(hook);
		if (restoreIndex === -1) {
			hooks.push(forwardSet(wrapCustomHook(hook)));
		} else {
			// we have already scene this hook, and it is being reverted (proxyquire, etc) - don't wrap again.
>>>>>>> 9d495daa1a0bedb7580a62196378715ed1a6d186
			hooks.splice(restoreIndex + 1, hooks.length);
			forwardSet(hook);
		}
	}

	Object.defineProperty(extensions, ext, {
		configurable: true,
		enumerable: true,
		get: forwardGet,
		set: setCurrentHook
	});
}
